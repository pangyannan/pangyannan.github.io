<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="飞星">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>飞星</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">飞星</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">飞星</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title"></h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-10-25
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>微服务链路追踪skywalking</p>
<h1 id="1-Skywalking概述"><a href="#1-Skywalking概述" class="headerlink" title="1 Skywalking概述"></a>1 Skywalking概述</h1><h2 id="1-1-什么是APM系统？"><a href="#1-1-什么是APM系统？" class="headerlink" title="1.1 什么是APM系统？"></a>1.1 什么是APM系统？</h2><h3 id="1-1-1-APM系统概述"><a href="#1-1-1-APM系统概述" class="headerlink" title="1.1.1 APM系统概述"></a>1.1.1 APM系统概述</h3><p>APM（Application Performance Management）即应用性能管理系统，是对企业系统即时监控以实现对应用程序性能管理和故障管理的系统化的解决方案。应用性能管理，主要是指企业的关键业务进行监控、优化，提高企业应用的可靠性和质量，保证用户得到良好的服务，降低IT总的拥有成本。</p>
<p>APM系统是可以帮助理解系统行为、用于分析性能问题的工具，以便发生故障的时候，能够快速定位和解决问题。</p>
<h3 id="1-1-2-分布式链路追踪"><a href="#1-1-2-分布式链路追踪" class="headerlink" title="1.1.2 分布式链路追踪"></a>1.1.2 分布式链路追踪</h3><p>随着分布式系统和微服务架构的出现，一次用户的请求会经过多个系统，不同服务之间的调用关系十分复杂，任何一个系统的出错都可能影响整个请求的处理结果。以往的监控系统往往只能知道单个系统的健康状况、一次请求的成功和失败，无法快速定位失败的根本原因。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193101930-7ded618d-26ef-45f6-847d-a16b9c8fd1c5.png" alt="img"></p>
<p>除此之外，复杂的分布式系统也面临这如下的问题：</p>
<ul>
<li>性能分析：一个服务依赖很多服务，被依赖的服务也依赖了其他的服务。如果某个接口耗时突然很长，那未必是直接调用的下游服务慢了，也可能是下游的下游服务变慢造成的，如何快速快速定位耗时变长的根本原因？</li>
<li>链路梳理：需求迭代很快，系统之间调用关系变化频繁，靠人工很难梳理出系统链路拓扑（系统之间的调用关系）。</li>
</ul>
<p>为了解决这些问题，Google推出了一个分布式链路追踪系统<code>Dapper</code>，之后各个互联网公司都参照<code>Dapper</code>的思想推出了自己的分布式链路追踪系统，而这些系统就是分布式系统下的APM系统。</p>
<h3 id="1-1-3-什么是OpenTracing？"><a href="#1-1-3-什么是OpenTracing？" class="headerlink" title="1.1.3 什么是OpenTracing？"></a>1.1.3 什么是OpenTracing？</h3><p>分布式链路追踪最先由Google在Dapper论文中提出的，而OpenTracing通过提供平台无关、厂商无关的API，使得开发人员能够方便的添加（或更换）追踪系统的实现。</p>
<p>下图是一个分布式调用的例子，客户端发起请求，请求首先到达负载均衡器，接着经过认证服务、订单服务，然后请求资源，最后返回结果。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193115330-ea3398e1-2d6e-4d08-a32d-40d7ccbfa860.jpeg" alt="img"></p>
<p>虽然这种图对于看清各个组件的组合关系很有用，但是存在着如下的问题：</p>
<ul>
<li><p>它不能很好的显示组件的调用时间，是串行调用还是并行调用，如果展现更复杂的调用关系，会更加复杂，甚至无法画出这样的图。</p>
</li>
<li><p>这种图也无法显示调用的时间间隔以及是否通过定时调用来启动调用。</p>
</li>
</ul>
<p>一种有效的展现一个调用过程的图：</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193126760-b4c6431c-4421-4f1b-870b-3f9a1911d92e.png" alt="img"></p>
<p>基于OpenTracing我们就可以很轻松的构建出如类似上面的图。</p>
<h3 id="1-1-4-主流的开源APM产品"><a href="#1-1-4-主流的开源APM产品" class="headerlink" title="1.1.4 主流的开源APM产品"></a>1.1.4 主流的开源APM产品</h3><ul>
<li><p>Pinpoint：</p>
<p>是由一个韩国团队实现并开源，针对Java编写的大规模分布式系统设计，通过JavaAgent的机制做字节码的植入，实现加入tranceid和获取性能数据的目的，对应用代码零侵入。 </p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://github.com/pinpoint-apm/pinpoint">https://github.com/pinpoint-apm/pinpoint</a></p>
</li>
<li><p>Skywalking：</p>
</li>
<li><p>Skywalking是apache基金会下面的一个开源APM项目，为微服务架构和云原生架构系统设计。它通过探针自动收集所需的指标，并进行分布式追踪。通过这些调用链路以及指标，Skywalking APM会感知应用间的关系和服务间的关系，并进行相应的指标统计。</p>
</li>
<li><p>Skywalking支持链路追踪和监控应用组件基本涵盖主流框架和容器，如国产RPC Dubbo和motan等，国际化的SpringBoot、SpringCloud。</p>
</li>
<li><p>官网：<a target="_blank" rel="noopener" href="http://skywalking.apache.org/">http://skywalking.apache.org</a></p>
</li>
<li><p>Zipkin：</p>
<p>是由Twitter开源，是分布式链路调用监控系统，聚合各业务系统调用延迟数据，达到链路调用监控跟踪。Zipkin基于Google的Dapper论文实现，主要完成数据的收集、存储、搜索和界面展示。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://zipkin.io/">https://zipkin.io</a></p>
</li>
</ul>
<ul>
<li><p>CAT：</p>
<p>是由大众点评开源的项目，基于Java开发的实时应用监控平台，包括实时应用监控、业务监控、可以提供几十张报表展示。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://github.com/dianping/cat">https://github.com/dianping/cat</a></p>
</li>
</ul>
<h2 id="1-2-什么是Skywalking"><a href="#1-2-什么是Skywalking" class="headerlink" title="1.2 什么是Skywalking"></a>1.2 什么是Skywalking</h2><h3 id="1-2-1-Skywalking概述"><a href="#1-2-1-Skywalking概述" class="headerlink" title="1.2.1 Skywalking概述"></a>1.2.1 Skywalking概述</h3><p>根据官方的解释，Skywalking是一个可观测分析平台（Observability Analysis Platform，简称OAP）和应用性能管理系统（Application Performance Management，简称APM）。</p>
<p>提供分布式链路追踪、服务网格（Service Mesh）遥测分析、度量（Metric）聚合和可视化一体化解决方案。</p>
<p>下面是Skywalking的几大特点：</p>
<ul>
<li>多语言自动探针，Java、.NET、和NodeJS等。</li>
<li>多种监控手段、语言探针和Service Mesh。</li>
<li>轻量高效，不需要额外搭建大数据平台。</li>
<li>模块化架构，UI、存储、集群管理多种机制可选。</li>
<li>支持告警。</li>
<li>优秀的可视化效果。</li>
</ul>
<p>Skywalking整体架构如下：</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193142342-a65a56d8-0ae6-41ae-a0eb-5037e7e792e3.png" alt="img"></p>
<p>Skywalking提供Tracing和Metric数据的获取和聚合。</p>
<blockquote>
<p>Metric的特点是，它是可累加的：它们都是原子性的，每个都是一个逻辑计量单元，或者一个时间段内的柱状图。例如：队列的当前深度可以被定义为一个计量单元，在写入或读取时被更新统计；输入HTTP请求的数量可以被定义为一个计数器，用于简单累加；请求的执行时间可以被定义为一个柱状图，在指定的时间片上更新和统计汇总。</p>
<p>Tracing的最大特点就是，它在单次请求的范围内，处理消息。任何的数据、元数据信息都被绑定到系统中的单个事务上。例如：一次调用远程服务的RPC执行过程，一次实际的SQL查询语句，一次HTTP请求的业务性ID。</p>
<p>总结：Metric主要用来进行数据的统计，比如HTTP请求数的计算；Tracing主要包含了某一次请求的链路数据。</p>
</blockquote>
<p>Skywalking的整体架构包含如下的三个组成部分：</p>
<ul>
<li>探针（agent）：负责进行数据的收集，包含了Tracing和Metric的数据，agent会被安装到服务所在的服务器上，以方便数据的获取。</li>
<li>可观测性分析平台OAP：接收探针发送的数据，并在内存中使用分析引擎进行数据的整合运算，然后将数据存储到对应的存储介质上，比如ElasticSearch、MySQL数据库、H2数据库等，同时OAP还使用查询引擎提供HTTP查询接口。</li>
<li>Skywalking提供单独的UI进行数据的查看：此时UI会调用OAP提供的接口，获取对应的数据然后进行展示。</li>
</ul>
<h3 id="1-2-2-Skywalking的优势"><a href="#1-2-2-Skywalking的优势" class="headerlink" title="1.2.2 Skywalking的优势"></a>1.2.2 Skywalking的优势</h3><p>Skywalking相比较其他的分布式链路监控工具，具有以下的特点：</p>
<ul>
<li>社区相当活跃。kywalking已经成为apache顶级项目，开发者是国人，可以直接和项目发起人交流进行问题的解决。</li>
<li>Skywalking支持Java、.NET和NodeJS语言。相对于其他平台，如Pinpoint支持Java和PHP，具有较大的优势。</li>
<li>探针无倾入性。对于CAT具有倾入性的探针，优势较大。不修改原有项目的一行代码就可以进行集成。</li>
<li>探针性能优秀。有网友对Pinpoint和Skywalking进行过测试，由于Pinpoint收集的数据过多，所以对性能损耗较大，而Skywalking探针性能十分出色。</li>
<li>支持组件较多。特别是对RPC框架的支持，这是其他框架所不具备的。Skywalking对Dubbo、gRpc等有原生的支持，甚至连小众的motan和sofarpc都支持。</li>
</ul>
<h3 id="1-2-3-Skywalking的主要概念介绍"><a href="#1-2-3-Skywalking的主要概念介绍" class="headerlink" title="1.2.3 Skywalking的主要概念介绍"></a>1.2.3 Skywalking的主要概念介绍</h3><p>Skywalking的主要概念包括：</p>
<ul>
<li>服务（Service）</li>
<li>端点（Endpoint）</li>
<li>实例（Instance）</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193156767-be59a23f-e914-4188-98e2-57306d36611c.png" alt="img"></p>
<p>上图中，我们编写了用户服务，这是一个web项目，在生产中部署了两个节点：192.168.1.100和192.168.1.101。</p>
<p>用户服务就是Skywalking的服务（Service），用户服务其实就是一个独立的应用（Application），在6.0之后的Skywalking将应用更名为服务。</p>
<p>用户服务对外提供的HTTP接口就是一个端点，端点就是对外提供的接口。</p>
<p>192.168.1.100和192.168.1.101这两个相同服务部署的节点就是实例，实例指同一服务可以部署多个。</p>
<h2 id="1-3-环境搭建"><a href="#1-3-环境搭建" class="headerlink" title="1.3 环境搭建"></a>1.3 环境搭建</h2><h3 id="1-3-1-概述及准备工作"><a href="#1-3-1-概述及准备工作" class="headerlink" title="1.3.1 概述及准备工作"></a>1.3.1 概述及准备工作</h3><p>我们在虚拟机中的CentOS7中搭建Skywalking的可观测性分析平台OAP环境。Skywalking默认使用H2内存数据库进行数据的存储，我们可以替换存储源为ElasticSearch保证其查询的高效和可用性。</p>
<p>本次使用的Skywalking的版本是8.3.0，下载地址 <a target="_blank" rel="noopener" href="https://apache.claz.org/skywalking/8.3.0/apache-skywalking-apm-es7-8.3.0.tar.gz">https://apache.claz.org/skywalking/8.3.0/apache-skywalking-apm-es7-8.3.0.tar.gz</a></p>
<p>本次使用的ElasticSearch的版本是7.10.0，下载地址：<a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.10.0-linux-x86_64.tar.gz">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.10.0-linux-x86_64.tar.gz</a></p>
<ul>
<li>创建skywalking目录：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/skywalking</span><br></pre></td></tr></table></figure>

<p>建议将虚拟机内存设置为3G并且CPU设置为2核，防止资源不足。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193220267-c977f549-3656-42c3-be2e-f1e70f5c06ec.png" alt="img"></p>
<ul>
<li>进入skywalking目录，并下载Skywalking和ElasticSearch：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://ftp.wayne.edu/apache/skywalking/8.3.0/apache-skywalking-apm-es7-8.3.0.tar.gz</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.10.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="1-3-2-安装ElasticSearch"><a href="#1-3-2-安装ElasticSearch" class="headerlink" title="1.3.2 安装ElasticSearch"></a>1.3.2 安装ElasticSearch</h3><ul>
<li>首先安装ElasticSearch，将压缩包解压：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf elasticsearch-7.10.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>修改Linux系统的限制配置，将文件创建数改为65536个：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#新增如下内容在limits.conf文件中</span><br><span class="line">es soft nofile 65536</span><br><span class="line">es hard nofile 65536</span><br><span class="line">es soft nproc 4096</span><br><span class="line">es hard nproc 4096</span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改系统中允许应用最多创建多少文件等的限制权限。Linux默认来说，一般限制应用最多创建的文件是65535个。但是ES最少需要65536的文件创建数的权限。</p>
</li>
<li><p>修改系统中允许用户启动的进程开启多少个线程。默认的Linux限制root用户开启的进程任意数量的线程，其他用户开启的进程最多1024个线程。必须修改限制树为4096+，因为ES至少需要4096的线程池预备。</p>
</li>
<li><p>修改系统控制权限，ElasticSearch需要开辟一个65536字节以上空间的虚拟内存。Linux默认不允许用户和应用程序直接开辟这么大的虚拟内存。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#新增如下内容在sysctl.conf文件中，当前用户拥有的内存权限大小 vm.max_map_count=262144 </span><br><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#让系统控制权限配置生效 </span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<ul>
<li>ES5之后不允许使用root用户启动，需要创建一个用户来启动ES：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建用户</span><br><span class="line">useradd es</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 修改上述用户的密码</span><br><span class="line">passwd es</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 修改es的目录的拥有者</span><br><span class="line">chown -R es /usr/local/skywalking/elasticsearch-7.10.0</span><br></pre></td></tr></table></figure>

<ul>
<li>默认情况下，ES是不支持跨域访问的，所以需要修改ES的配置文件elasticsearch.yml，添加如下的参数：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/skywalking/elasticsearch-7.10.0/config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node.name: node-1  </span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]  </span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">xpack.ml.enabled: false </span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: /.*/</span><br></pre></td></tr></table></figure>

<ul>
<li>启动ES：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 切换用户</span><br><span class="line">su es</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking/elasticsearch-7.10.0/bin</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 后台启动</span><br><span class="line">./elasticsearch -d</span><br></pre></td></tr></table></figure>

<ul>
<li>测试：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9200</span><br></pre></td></tr></table></figure>



<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193337345-91359198-f9bd-4afe-93e9-e867fe9fbf68.png" alt="img"></p>
<h3 id="1-3-3-安装Skywalking"><a href="#1-3-3-安装Skywalking" class="headerlink" title="1.3.3 安装Skywalking"></a>1.3.3 安装Skywalking</h3><p>安装Skywalking分为两个步骤：</p>
<ul>
<li><p>安装Backend后端服务。</p>
</li>
<li><p>安装UI。</p>
</li>
<li><p>首先切回root用户，切换到skywalking目录下，解压skywalking：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 切换到root用户</span><br><span class="line">su root</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 切换到skywalking目录</span><br><span class="line">cd /usr/local/skywalking</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 解压skywalking</span><br><span class="line">tar -zxvf apache-skywalking-apm-es7-8.3.0.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>修改Skywalking的数据源配置：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd apache-skywalking-apm-bin-es7/config</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim application.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>我们可以发现默认是H2。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193351581-bf0e4510-588d-4c40-9b57-72cb93bef6fd.png" alt="img"></p>
<ul>
<li>更改为ElasticSearch7：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">  selector: $&#123;SW_STORAGE:elasticsearch7&#125;</span><br><span class="line">  elasticsearch7:</span><br><span class="line">    nameSpace: $&#123;SW_NAMESPACE:&quot;elasticsearch&quot;&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193363034-4a05f70c-d56e-41d5-882e-005596ca29bc.png" alt="img"></p>
<ul>
<li>默认使用了localhost下的ES，所以我们不需要做任何处理，直接使用即可，启动OAP程序：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking/apache-skywalking-apm-bin-es7/bin</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./oapService.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193374779-7b5762c1-fa44-4558-b0e6-873af4adf343.png" alt="img"></p>
<ul>
<li>这样Backend后端服务就已经安装完毕了，接下来需要安装UI，先看下UI的配置文件：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking/apache-skywalking-apm-bin-es7/webapp</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat webapp.yml</span><br></pre></td></tr></table></figure>

<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193385649-1c183b21-e39f-4bc1-a798-7f87a749eb6c.png" alt="img"></p>
<ul>
<li>目前的默认配置不需要修改就可以使用，启动UI程序：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking/apache-skywalking-apm-bin-es7/bin</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./webappService.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193396756-5ab3e93b-ae6e-4c74-8e96-7e4b83460e84.png" alt="img"></p>
<ul>
<li>我们可以通过浏览器访问Skywalking的可视化页面，访问地址为：<a href="http://localhost:8080（假设虚拟机中CentOS7的IP是192.168.159.103，那么将lcoalhost改为192.168.159.103），如果出现下面的图，就代表安装成功了。">http://localhost:8080（假设虚拟机中CentOS7的IP是192.168.159.103，那么将lcoalhost改为192.168.159.103），如果出现下面的图，就代表安装成功了。</a></li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193407110-5b084dd6-cbea-4a76-849a-41908c4f9122.png" alt="img"></p>
<h1 id="2-Skywalking基础"><a href="#2-Skywalking基础" class="headerlink" title="2 Skywalking基础"></a>2 Skywalking基础</h1><h2 id="2-1-agent的使用"><a href="#2-1-agent的使用" class="headerlink" title="2.1 agent的使用"></a>2.1 agent的使用</h2><p>agent探针可以让我们不修改代码的情况下，对Java应用上使用到的组件进行动态监控，获取运行数据发送到OAP上进行统计和存储。</p>
<p>agent探针在Java中是使用Java agent技术实现的，不需要更改任何代码，Java agent会通过虚拟机（JVM）接口来在运行期更改代码。</p>
<p>agent探针支持JDK1.6-12的版本，agent探针所有的文件在Skywalking的agent文件夹下，文件目录如下：</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193418948-0ba41a26-8fce-4b57-b042-1884b8f9e0fc.png" alt="img"></p>
<p>部分插件在使用上会影响整体的性能或者由于版权问题放置在可选插件包上，不会直接加载，如果需要使用，将可选插件中的jar包复制到plugins包下即可。</p>
<p>由于没有修改agent探针中的应用名，所以默认显示的是Your_ApplicationName，我们修改下应用名，让其显示更加准确。编辑agent的配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/config</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim agent.config</span><br></pre></td></tr></table></figure>

<p>找到如下的一行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent.service_name=$&#123;SW_AGENT_NAME:Your_ApplicationName&#125;</span><br></pre></td></tr></table></figure>

<p>这里的配置含义是可以读取到SW_AGENT_NAME的配置属性，如果该属性没有指定，那么默认名称就是Your_ApplicationName。我们这里将Your_ApplicationName改为skywalking_boot。</p>
<h2 id="2-2-Skywalking和Springboot的集成使用"><a href="#2-2-Skywalking和Springboot的集成使用" class="headerlink" title="2.2 Skywalking和Springboot的集成使用"></a>2.2 Skywalking和Springboot的集成使用</h2><h3 id="2-2-1-准备SpringBoot项目"><a href="#2-2-1-准备SpringBoot项目" class="headerlink" title="2.2.1 准备SpringBoot项目"></a>2.2.1 准备SpringBoot项目</h3><p>pom.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.7.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.example&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;springboot2&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;springboot2&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;11&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">            &lt;exclusions&gt;</span><br><span class="line">                &lt;exclusion&gt;</span><br><span class="line">                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;</span><br><span class="line">                &lt;/exclusion&gt;</span><br><span class="line">            &lt;/exclusions&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>



<p>启动类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class Springboot2Application &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(Springboot2Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>业务类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.web;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-12 09:18</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/hello&quot;)</span><br><span class="line">    public String hello() &#123;</span><br><span class="line">        return &quot;你好啊&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/exception&quot;)</span><br><span class="line">    public String exception()&#123;</span><br><span class="line">        int i = 10 /0;</span><br><span class="line">        return &quot;你怎么可以这个样子&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193438164-9083ef8c-4063-470c-96ee-2578d6531aa7.png" alt="img"></p>
<h3 id="2-2-2-通过工具将SpringBoot项目打包，并上传至-usr-local-skywalking目录"><a href="#2-2-2-通过工具将SpringBoot项目打包，并上传至-usr-local-skywalking目录" class="headerlink" title="2.2.2 通过工具将SpringBoot项目打包，并上传至/usr/local/skywalking目录"></a>2.2.2 通过工具将SpringBoot项目打包，并上传至/usr/local/skywalking目录</h3><ul>
<li>略。</li>
</ul>
<h3 id="2-2-3-使用命令启动SpringBoot项目"><a href="#2-2-3-使用命令启动SpringBoot项目" class="headerlink" title="2.2.3 使用命令启动SpringBoot项目"></a>2.2.3 使用命令启动SpringBoot项目</h3><ul>
<li>启动命令：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar -Dserver.port=8082 -jar springboot2-1.0.jar &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用jar包启动的项目如果需要集成Skywalking，需要添加-javaagent参数，参数值为agent的jar包的绝对路径。</p>
</li>
<li><p>-Dserver.port参数用于指定端口号，防止和Skywalking端口冲突。</p>
</li>
<li><p>末尾添加&amp;后台运行模式启动SpringBoot项目。</p>
</li>
</ul>
<h3 id="2-2-4-访问Skywalking的UI页面"><a href="#2-2-4-访问Skywalking的UI页面" class="headerlink" title="2.2.4 访问Skywalking的UI页面"></a>2.2.4 访问Skywalking的UI页面</h3><ul>
<li>通过访问<a target="_blank" rel="noopener" href="http://192.168.159.103:8082/hello%E5%9C%B0%E5%9D%80%E6%9D%A5%E8%BF%9B%E8%A1%8C%E8%AE%BF%E9%97%AE%EF%BC%8C%E8%AE%BF%E9%97%AE%E4%B9%8B%E5%90%8E%E7%A8%8D%E7%AD%89%E7%89%87%E5%88%BB%E8%AE%BF%E9%97%AESkywalking%E7%9A%84UI%E9%A1%B5%E9%9D%A2%E3%80%82">http://192.168.159.103:8082/hello地址来进行访问，访问之后稍等片刻访问Skywalking的UI页面。</a></li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193452922-6f798c98-6310-4bc1-b7d9-6396099c1467.png" alt="img"></p>
<h3 id="2-2-5在IDEA中使用"><a href="#2-2-5在IDEA中使用" class="headerlink" title="2.2.5在IDEA中使用"></a>2.2.5在IDEA中使用</h3><p>假设我本地的文件路径为<code>D:\workSpace\apache-skywalking-apm-es7-8.7.0\agent</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:D:\workSpace\apache-skywalking-apm-es7-8.7.0\agent/skywalking-agent.jar=agent.service_name=Stock,collector.backend_service=127.0.0.1:11800</span><br></pre></td></tr></table></figure>



<h2 id="2-3-Rocketbot的使用"><a href="#2-3-Rocketbot的使用" class="headerlink" title="2.3 Rocketbot的使用"></a>2.3 Rocketbot的使用</h2><h3 id="2-3-1-概述"><a href="#2-3-1-概述" class="headerlink" title="2.3.1 概述"></a>2.3.1 概述</h3><ul>
<li>Skywalking的监控页面为Rocketbot，我们可以通过8080端口进行访问，由于8080端口很容易冲突，可以吸怪webapp/webapp.yaml来更改启动端口。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server: </span><br><span class="line">  port: 9010 # 修改为9010</span><br></pre></td></tr></table></figure>

<ul>
<li>我们修改为9010端口防止冲突。</li>
</ul>
<h3 id="2-3-2-仪表盘"><a href="#2-3-2-仪表盘" class="headerlink" title="2.3.2 仪表盘"></a>2.3.2 仪表盘</h3><p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193464824-4772ea87-6b2b-4488-933f-1398b858e976.png" alt="img"></p>
<h3 id="2-3-3-拓扑图"><a href="#2-3-3-拓扑图" class="headerlink" title="2.3.3 拓扑图"></a>2.3.3 拓扑图</h3><p>Skywalking提供拓扑图，直观的查看服务之间的调用关系。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193475234-bf80d51c-f87a-41d6-8059-ae3843730371.png" alt="img"></p>
<h3 id="2-3-4-追踪"><a href="#2-3-4-追踪" class="headerlink" title="2.3.4 追踪"></a>2.3.4 追踪</h3><p>在Skywalking中，每一次用户发起一个请求，就可以视为一条追踪数据，每条追踪数据携带有一个ID值，追踪数据可以在追踪页面进行查询。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193486559-1f88469b-66fc-4a56-8504-c8b11e7fd60c.png" alt="img"></p>
<p>左侧是追踪列表，也可以通过上方的追踪ID来进行查询。点击追踪列表的某一条记录之后，右侧会显示出这条追踪的详细信息。有三种显示结果：列表、树结构和表格。</p>
<p>可以很好的展现这表追踪的调用链情况上的每个节点，可以通过左键点击节点，查看详细信息：</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193498379-7af5f4bb-2d38-4f5f-847c-9564514c6c0b.png" alt="img"></p>
<p>当前的接口是HTTP的GET请求，相对比较简单，如果出现异常情况或者数据库的访问，也会打印出异常信息、堆栈甚至详细的SQL语句。</p>
<h3 id="2-3-5-告警"><a href="#2-3-5-告警" class="headerlink" title="2.3.5 告警"></a>2.3.5 告警</h3><p>Skywalking中的告警功能相对比较简单，在到达告警阈值之后会生成一条告警记录，在告警页面上进行展示。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/513185/1611193510411-3cdb0c21-2f25-46e3-806f-961f1ede01c5.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_44,text_6K645aSn5LuZ,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h1 id="3-Skywalking高级"><a href="#3-Skywalking高级" class="headerlink" title="3 Skywalking高级"></a>3 Skywalking高级</h1><h2 id="3-1-MySQL调用监控"><a href="#3-1-MySQL调用监控" class="headerlink" title="3.1 MySQL调用监控"></a>3.1 MySQL调用监控</h2><h3 id="3-1-1-前提条件"><a href="#3-1-1-前提条件" class="headerlink" title="3.1.1 前提条件"></a>3.1.1 前提条件</h3><ul>
<li><p>虚拟机中已经安装好了Docker（略）。</p>
</li>
<li><p>SpringBoot使用Spring Data JPA操作MySQL。</p>
</li>
</ul>
<h3 id="3-1-2-Docker命令启动MySQL"><a href="#3-1-2-Docker命令启动MySQL" class="headerlink" title="3.1.2 Docker命令启动MySQL"></a>3.1.2 Docker命令启动MySQL</h3><ul>
<li>Docker命令启动MySQL：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id -p 3306:3306 --name mysql5.7 -v /var/mysql5.7/conf:/etc/mysql/conf.d -v /var/mysql5.7/logs:/logs -v /var/mysql5.7/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --restart=always mysql:5.7 --lower_case_table_names=1</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-sql脚本"><a href="#3-1-3-sql脚本" class="headerlink" title="3.1.3 sql脚本"></a>3.1.3 sql脚本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create database if not exists skywalking;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `user`;</span><br><span class="line">CREATE TABLE `user`  (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Dynamic;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `user` VALUES (1, &#x27;张三&#x27;);</span><br><span class="line">INSERT INTO `user` VALUES (2, &#x27;李四&#x27;);</span><br><span class="line">INSERT INTO `user` VALUES (3, &#x27;王五&#x27;);</span><br></pre></td></tr></table></figure>

<h3 id="3-1-Spring-Data-JPA访问MySQL"><a href="#3-1-Spring-Data-JPA访问MySQL" class="headerlink" title="3.1. Spring Data JPA访问MySQL"></a>3.1. Spring Data JPA访问MySQL</h3><ul>
<li>可以直接使用刚才创建的SpringBoot的项目，只需要导入MySQL和Spring Data JPA相关的依赖即可。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 增加的依赖 --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li>在resources目录下新建application.yml文件：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  # 配置数据源</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://192.168.159.103:3306/skywalking?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;useSSL=false&amp;serverTimezone=GMT%2B8&amp;allowPublicKeyRetrieval=true&amp;nullCatalogMeansCurrent=true</span><br><span class="line">    username: root</span><br><span class="line">    password: 123456</span><br><span class="line">    # Hikari 连接池配置</span><br><span class="line">    hikari:</span><br><span class="line">      # 最小空闲连接数量</span><br><span class="line">      minimum-idle: 5</span><br><span class="line">      # 空闲连接存活最大时间，默认600000（10分钟）</span><br><span class="line">      idle-timeout: 180000</span><br><span class="line">      # 连接池最大连接数，默认是10</span><br><span class="line">      maximum-pool-size: 1000</span><br><span class="line">      # 此属性控制从池返回的连接的默认自动提交行为,默认值：true</span><br><span class="line">      auto-commit: true</span><br><span class="line">      # 连接池名称</span><br><span class="line">      pool-name: HikariCP</span><br><span class="line">      # 此属性控制池中连接的最长生命周期，值0表示无限生命周期，默认1800000即30分钟</span><br><span class="line">      max-lifetime: 1800000</span><br><span class="line">      # 数据库连接超时时间,默认30秒，即30000</span><br><span class="line">      connection-timeout: 30000</span><br><span class="line">      connection-test-query: SELECT 1</span><br><span class="line">      data-source-properties:</span><br><span class="line">        useInformationSchema: true</span><br></pre></td></tr></table></figure>



<ul>
<li>新建实体类：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.domain;</span><br><span class="line"></span><br><span class="line">import org.hibernate.annotations.DynamicInsert;</span><br><span class="line">import org.hibernate.annotations.DynamicUpdate;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.Objects;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 14:55</span><br><span class="line"> */</span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;`user`&quot;)</span><br><span class="line">@DynamicInsert</span><br><span class="line">@DynamicUpdate</span><br><span class="line">public class User implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">        @Id</span><br><span class="line">        @GeneratedValue(strategy = GenerationType.IDENTITY)</span><br><span class="line">        private Integer id;</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line">        private String name;</span><br><span class="line"></span><br><span class="line">        public Integer getId() &#123;</span><br><span class="line">                return id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void setId(Integer id) &#123;</span><br><span class="line">                this.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String getName() &#123;</span><br><span class="line">                return name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void setName(String name) &#123;</span><br><span class="line">                this.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean equals(Object o) &#123;</span><br><span class="line">                if (this == o) return true;</span><br><span class="line">                if (o == null || getClass() != o.getClass()) return false;</span><br><span class="line">                User user = (User) o;</span><br><span class="line">                return Objects.equals(id, user.id) &amp;&amp; Objects.equals(name, user.name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int hashCode() &#123;</span><br><span class="line">                return Objects.hash(id, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">                return &quot;User&#123;&quot; +</span><br><span class="line">                        &quot;id=&quot; + id +</span><br><span class="line">                        &quot;, name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                        &#x27;&#125;&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>新建Dao：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.dao;</span><br><span class="line"></span><br><span class="line">import com.example.springboot2.domain.User;</span><br><span class="line">import org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line">import org.springframework.data.jpa.repository.JpaSpecificationExecutor;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 14:58</span><br><span class="line"> */</span><br><span class="line">public interface UserRepository extends JpaRepository&lt;User, Integer&gt;, JpaSpecificationExecutor&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>新建Service：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.service;</span><br><span class="line"></span><br><span class="line">import com.example.springboot2.dao.UserRepository;</span><br><span class="line">import com.example.springboot2.domain.User;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import javax.transaction.Transactional;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 15:01</span><br><span class="line"> */</span><br><span class="line">@Service</span><br><span class="line">@Transactional</span><br><span class="line">public class UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * 查询所有用户信息</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public List&lt;User&gt; findAll() &#123;</span><br><span class="line">        return userRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>新建Controller：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.web;</span><br><span class="line"></span><br><span class="line">import com.example.springboot2.domain.User;</span><br><span class="line">import com.example.springboot2.service.UserService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 15:03</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(value = &quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/findAll&quot;)</span><br><span class="line">    public List&lt;User&gt; findAll()&#123;</span><br><span class="line">        return userService.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-1-5-部署方式"><a href="#3-1-5-部署方式" class="headerlink" title="3.1.5 部署方式"></a>3.1.5 部署方式</h3><ul>
<li><p>将SpringBoot项目打包，上传到/usr/local/skywalking的目录中（略）。</p>
</li>
<li><p>切换到/usr/local/skywalking，启动SpringBoot：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar -Dserver.port=8082 -jar springboot2-1.0.jar &amp;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-6-调用接口"><a href="#3-1-6-调用接口" class="headerlink" title="3.1.6 调用接口"></a>3.1.6 调用接口</h3><ul>
<li>访问的地址是：<a target="_blank" rel="noopener" href="http://192.168.159.103:8082/user/findAll%E3%80%82">http://192.168.159.103:8082/user/findAll。</a></li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193534936-566c0170-1e94-4740-b77f-8805e410edac.png" alt="img"></p>
<h3 id="3-1-7-打开skywalking查看mysql调用的监控情况"><a href="#3-1-7-打开skywalking查看mysql调用的监控情况" class="headerlink" title="3.1.7 打开skywalking查看mysql调用的监控情况"></a>3.1.7 打开skywalking查看mysql调用的监控情况</h3><ul>
<li>数据库仪表盘：</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193545726-9b0b607d-b45a-4ed6-a48a-5b27fd022f35.png" alt="img"></p>
<ul>
<li>拓扑图：</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193557331-843a279a-b9cd-43da-b9ff-cc503d6acd09.png" alt="img"></p>
<ul>
<li>追踪：</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193568192-cd743076-0f4c-4ea2-8726-720be537df6d.png" alt="img"></p>
<ul>
<li>点击MySQL的调用，可以看到详细的SQL语句。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193581096-23d5d277-ae0b-4a50-851e-bfd1d0f49278.png" alt="img"></p>
<ul>
<li>这样就可以很好的定位问题产生的原因，特别是在某些SQL语句执行慢的情况下。</li>
</ul>
<h2 id="3-2-配置覆盖"><a href="#3-2-配置覆盖" class="headerlink" title="3.2 配置覆盖"></a>3.2 配置覆盖</h2><h3 id="3-2-1-概述"><a href="#3-2-1-概述" class="headerlink" title="3.2.1 概述"></a>3.2.1 概述</h3><ul>
<li><p>我们每次部署应用都需要到agent中修改服务名，如果部署多个应用，那么只能复制agent以便产生隔离，但是这样非常麻烦。我们可以用Skywalking提供的配置覆盖功能通过启动命令动态的指定服务名，这样agent就只需要部署一份即可。</p>
</li>
<li><p>Skywalking支持以下几种配置：</p>
</li>
<li><ul>
<li>系统配置。</li>
</ul>
</li>
<li><ul>
<li>探针配置。</li>
</ul>
</li>
<li><ul>
<li>系统环境变量。</li>
</ul>
</li>
<li><ul>
<li>配置文件中的值（上面的案例中我们就是这样使用）。</li>
</ul>
</li>
</ul>
<h3 id="3-2-2-系统配置（System-Properties）"><a href="#3-2-2-系统配置（System-Properties）" class="headerlink" title="3.2.2 系统配置（System Properties）"></a>3.2.2 系统配置（System Properties）</h3><ul>
<li><p>使用<code>skywalking.</code>+配置文件中的配置名作为系统配置项来进行覆盖。</p>
</li>
<li><p>例如：通过命令行启动的时候加上如下的参数可以进行<code>agent.service_name</code>的覆盖</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dskywalking.agent.service_name=skywalking_mysql</span><br></pre></td></tr></table></figure>



<h3 id="3-2-3-探针配置（Agent-Options）"><a href="#3-2-3-探针配置（Agent-Options）" class="headerlink" title="3.2.3 探针配置（Agent Options）"></a>3.2.3 探针配置（Agent Options）</h3><ul>
<li>可以指定探针的时候加上参数，如果配置中包含分隔符（,或=），就必须使用引号（‘’）包裹起来。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar=[option]=[value],[option]=[value]</span><br></pre></td></tr></table></figure>



<ul>
<li>例如：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar=agent.service_name=skywalking_mysql</span><br></pre></td></tr></table></figure>



<h3 id="3-2-4-系统环境变量"><a href="#3-2-4-系统环境变量" class="headerlink" title="3.2.4 系统环境变量"></a>3.2.4 系统环境变量</h3><ul>
<li><p>案例：</p>
</li>
<li><p>由于agent.service_name配置项如下所示</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agent.service_name=$&#123;SW_AGENT_NAME:Your_ApplicationName&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以在环境变量中设置SW_AGENT_NAME的值来指定服务名。</li>
</ul>
<h3 id="3-2-5-覆盖的优先级"><a href="#3-2-5-覆盖的优先级" class="headerlink" title="3.2.5 覆盖的优先级"></a>3.2.5 覆盖的优先级</h3><ul>
<li><p>探针配置&gt;系统配置&gt;系统环境变量&gt;配置文件中的值。</p>
</li>
<li><p>简而言之，推荐使用<code>探针方式</code>或<code>系统配置</code>的方式。</p>
</li>
</ul>
<h2 id="3-3-获取追踪的ID"><a href="#3-3-获取追踪的ID" class="headerlink" title="3.3 获取追踪的ID"></a>3.3 获取追踪的ID</h2><h3 id="3-3-1-概述"><a href="#3-3-1-概述" class="headerlink" title="3.3.1 概述"></a>3.3.1 概述</h3><p>Skywalking提供了Trace工具包，用于在追踪链路的时候进行信息的打印或者获取对应的追踪ID。</p>
<h3 id="3-3-2-应用示例"><a href="#3-3-2-应用示例" class="headerlink" title="3.3.2 应用示例"></a>3.3.2 应用示例</h3><ul>
<li>在pom.xml中增加Trace工具包的坐标：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.skywalking&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;apm-toolkit-trace&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;8.3.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li>修改Controller.java</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.web;</span><br><span class="line"></span><br><span class="line">import org.apache.skywalking.apm.toolkit.trace.ActiveSpan;</span><br><span class="line">import org.apache.skywalking.apm.toolkit.trace.TraceContext;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-12 09:18</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/hello&quot;)</span><br><span class="line">    public String hello() &#123;</span><br><span class="line">        return &quot;你好啊&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * TraceContext.traceId() 可以打印出当前追踪的ID，方便在Rocketbot中搜索</span><br><span class="line">     * ActiveSpan提供了三个方法进行信息打印：</span><br><span class="line">     *   error：会将本次调用转为失败状态，同时可以打印对应的堆栈信息和错误提示</span><br><span class="line">     *   info：打印info级别额信息</span><br><span class="line">     *   debug：打印debug级别的信息</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @RequestMapping(value = &quot;/exception&quot;)</span><br><span class="line">    public String exception() &#123;</span><br><span class="line">        ActiveSpan.info(&quot;打印info信息&quot;);</span><br><span class="line">        ActiveSpan.debug(&quot;打印debug信息&quot;);</span><br><span class="line">        //使得当前的链路报错，并且提示报错信息</span><br><span class="line">        try &#123;</span><br><span class="line">            int i = 10 / 0;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            ActiveSpan.error(new RuntimeException(&quot;报错了&quot;));</span><br><span class="line">            //返回trace id</span><br><span class="line">            return TraceContext.traceId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;你怎么可以这个样子&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>将项目打包，部署，并使用如下的命令启动：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar -Dserver.port=8082   -Dskywalking.agent.service_name=skywalking_mysql -jar springboot2-1.0.jar &amp;</span><br></pre></td></tr></table></figure>



<ul>
<li>访问接口，获取追踪的ID：</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193601741-3a83df09-fc7c-439d-b57d-17ccfb31f661.png" alt="img"></p>
<ul>
<li>可以看到追踪的ID已经打印出来了，此时我们在Rocketbot上进行搜索。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193613641-f360b853-4e94-4a95-b6cd-b83275ab2052.png" alt="img"></p>
<ul>
<li>可以搜索到对应的追踪记录，但是显示调用是失败的，这是因为使用了ActiveSpan.error方法，点开追踪的详细信息。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193624588-e1ed1c09-838c-4919-ada9-a2fbbdc80dde.png" alt="img"></p>
<h2 id="3-4-过滤指定的端点"><a href="#3-4-过滤指定的端点" class="headerlink" title="3.4 过滤指定的端点"></a>3.4 过滤指定的端点</h2><h3 id="3-4-1-概述"><a href="#3-4-1-概述" class="headerlink" title="3.4.1 概述"></a>3.4.1 概述</h3><p>在开发的过程中，有一些端点（接口）并不需要去进行监控，比如Swagger相关的端点。这个时候我们使用Skywalking提供的过滤插件来进行过滤。</p>
<h3 id="3-4-2-应用示例"><a href="#3-4-2-应用示例" class="headerlink" title="3.4.2 应用示例"></a>3.4.2 应用示例</h3><ul>
<li>在上面的SpringBoot项目中增加如下的控制器：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.web;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 16:46</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class FilterController &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 此接口可以被追踪</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(value = &quot;/include&quot;)</span><br><span class="line">    public String include() &#123;</span><br><span class="line">        return &quot;include&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 此接口不可以被追踪</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(value = &quot;/exclude&quot;)</span><br><span class="line">    public String exclude() &#123;</span><br><span class="line">        return &quot;exclude&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>将项目打包并上传到/usr/local/skywalking中。</p>
</li>
<li><p>将agent中的agent/optional-plugins/apm-trace-ignore-plugin-8.3.0.jar插件复制到plugins目录中。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/skywalking/apache-skywalking-apm-bin-es7/agent</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp optional-plugins/apm-trace-ignore-plugin-8.3.0.jar plugins/</span><br></pre></td></tr></table></figure>



<ul>
<li>启动SpringBoot应用，并添加过滤参数。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar -Dserver.port=8082 -Dskywalking.agent.service_name=skywalking_mysql -Dskywalking.trace.ignore_path=/exclude -jar springboot2-1.0.jar &amp;</span><br></pre></td></tr></table></figure>



<p>这里添加<code>-Dskywalking.trace.ignore_path</code>参数来标识需要过滤那些请求，支持<code>Ant Path</code>表达式：</p>
<ul>
<li><p><code>/path/*</code>，<code>/path/**</code>，<code>/path/?</code></p>
</li>
<li><p><code>?</code> 匹配任何单字符</p>
</li>
<li><p><code>*</code>匹配0或者任意数量的字符</p>
</li>
<li><p><code>**</code>匹配0或者更多的目录</p>
</li>
<li><p>调用接口，接口的地址为：</p>
</li>
<li><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.159.103:8082/include%E3%80%82">http://192.168.159.103:8082/include。</a></li>
</ul>
</li>
<li><ul>
<li><a target="_blank" rel="noopener" href="http://192.168.159.103:8082/exclude%E3%80%82">http://192.168.159.103:8082/exclude。</a></li>
</ul>
</li>
<li><p>会发现exclude接口已经被过滤了，只有include接口能被看到。</p>
</li>
</ul>
<h2 id="3-5-告警功能"><a href="#3-5-告警功能" class="headerlink" title="3.5 告警功能"></a>3.5 告警功能</h2><h3 id="3-5-1-概述"><a href="#3-5-1-概述" class="headerlink" title="3.5.1 概述"></a>3.5.1 概述</h3><p>Skywalking每隔一段时间根据收集到的链路追踪的数据和配置的告警规则（如服务响应时间、服务响应时间百分比）等，判断如果达到阈值则发送相应的告警信息。发送告警信息是通过调用webhook接口完成，具体的webhook接口可以由使用者自行定义，从而开发者可以在指定的webhook接口中编写各种告警方式，比如邮、短信等。告警的信息也可以在Rocketbot中查看到。</p>
<p>以下是默认的告警规则配置，位于Skywalking安装目录下的config文件下的<code>alarm-settings.yml</code>文件中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># Sample alarm rules.</span><br><span class="line">rules:</span><br><span class="line">  # Rule unique name, must be ended with `_rule`.</span><br><span class="line">  service_resp_time_rule:</span><br><span class="line">    metrics-name: service_resp_time</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    threshold: 1000</span><br><span class="line">    period: 10</span><br><span class="line">    count: 3</span><br><span class="line">    silence-period: 5</span><br><span class="line">    message: Response time of service &#123;name&#125; is more than 1000ms in 3 minutes of last 10 minutes.</span><br><span class="line">  service_sla_rule:</span><br><span class="line">    # Metrics value need to be long, double or int</span><br><span class="line">    metrics-name: service_sla</span><br><span class="line">    op: &quot;&lt;&quot;</span><br><span class="line">    threshold: 8000</span><br><span class="line">    # The length of time to evaluate the metrics</span><br><span class="line">    period: 10</span><br><span class="line">    # How many times after the metrics match the condition, will trigger alarm</span><br><span class="line">    count: 2</span><br><span class="line">    # How many times of checks, the alarm keeps silence after alarm triggered, default as same as period.</span><br><span class="line">    silence-period: 3</span><br><span class="line">    message: Successful rate of service &#123;name&#125; is lower than 80% in 2 minutes of last 10 minutes</span><br><span class="line">  service_resp_time_percentile_rule:</span><br><span class="line">    # Metrics value need to be long, double or int</span><br><span class="line">    metrics-name: service_percentile</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    threshold: 1000,1000,1000,1000,1000</span><br><span class="line">    period: 10</span><br><span class="line">    count: 3</span><br><span class="line">    silence-period: 5</span><br><span class="line">    message: Percentile response time of service &#123;name&#125; alarm in 3 minutes of last 10 minutes, due to more than one condition of p50 &gt; 1000, p75 &gt; 1000, p90 &gt; 1000, p95 &gt; 1000, p99 &gt; 1000</span><br><span class="line">  service_instance_resp_time_rule:</span><br><span class="line">    metrics-name: service_instance_resp_time</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    threshold: 1000</span><br><span class="line">    period: 10</span><br><span class="line">    count: 2</span><br><span class="line">    silence-period: 5</span><br><span class="line">    message: Response time of service instance &#123;name&#125; is more than 1000ms in 2 minutes of last 10 minutes</span><br><span class="line">  database_access_resp_time_rule:</span><br><span class="line">    metrics-name: database_access_resp_time</span><br><span class="line">    threshold: 1000</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    period: 10</span><br><span class="line">    count: 2</span><br><span class="line">    message: Response time of database access &#123;name&#125; is more than 1000ms in 2 minutes of last 10 minutes</span><br><span class="line">  endpoint_relation_resp_time_rule:</span><br><span class="line">    metrics-name: endpoint_relation_resp_time</span><br><span class="line">    threshold: 1000</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    period: 10</span><br><span class="line">    count: 2</span><br><span class="line">    message: Response time of endpoint relation &#123;name&#125; is more than 1000ms in 2 minutes of last 10 minutes</span><br><span class="line">#  Active endpoint related metrics alarm will cost more memory than service and service instance metrics alarm.</span><br><span class="line">#  Because the number of endpoint is much more than service and instance.</span><br><span class="line">#</span><br><span class="line">#  endpoint_avg_rule:</span><br><span class="line">#    metrics-name: endpoint_avg</span><br><span class="line">#    op: &quot;&gt;&quot;</span><br><span class="line">#    threshold: 1000</span><br><span class="line">#    period: 10</span><br><span class="line">#    count: 2</span><br><span class="line">#    silence-period: 5</span><br><span class="line">#    message: Response time of endpoint &#123;name&#125; is more than 1000ms in 2 minutes of last 10 minutes</span><br><span class="line"></span><br><span class="line">webhooks:</span><br><span class="line">#  - http://127.0.0.1/notify/</span><br><span class="line">#  - http://127.0.0.1/go-wechat/</span><br></pre></td></tr></table></figure>



<p>规则中的参数属性如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>metrics-name</td>
<td>oal脚本中的度量名称</td>
</tr>
<tr>
<td>threshold</td>
<td>阈值，与metrics-name和下面的比较符号相匹配，单位毫秒</td>
</tr>
<tr>
<td>op</td>
<td>比较操作符，可以设定&gt;,&lt;,=</td>
</tr>
<tr>
<td>period</td>
<td>多久检查一次当前的指标数据是否符合告警规则，单位分钟</td>
</tr>
<tr>
<td>count</td>
<td>达到多少次后，发送告警消息</td>
</tr>
<tr>
<td>silence-period</td>
<td>在多久之内，忽略相同的告警消息，单位分钟</td>
</tr>
<tr>
<td>message</td>
<td>告警消息内容</td>
</tr>
<tr>
<td>include-names</td>
<td>本规则告警生效的服务列表</td>
</tr>
</tbody></table>
<p>webhooks可以配置告警产生时的调用地址。</p>
<h3 id="3-5-2-告警功能测试"><a href="#3-5-2-告警功能测试" class="headerlink" title="3.5.2 告警功能测试"></a>3.5.2 告警功能测试</h3><ul>
<li>定义一个实体类用于封装接口告警信息：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.domain;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 17:31</span><br><span class="line"> */</span><br><span class="line">public class AlarmMessage &#123;</span><br><span class="line"></span><br><span class="line">    private Integer  scopeId;</span><br><span class="line">    private String name;</span><br><span class="line">    private Integer  id0;</span><br><span class="line">    private Integer  id1;</span><br><span class="line">    private String alarmMessage;</span><br><span class="line">    private long startTime;</span><br><span class="line"></span><br><span class="line">    public Integer getScopeId() &#123;</span><br><span class="line">        return scopeId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setScopeId(Integer scopeId) &#123;</span><br><span class="line">        this.scopeId = scopeId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getId0() &#123;</span><br><span class="line">        return id0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId0(Integer id0) &#123;</span><br><span class="line">        this.id0 = id0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getId1() &#123;</span><br><span class="line">        return id1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId1(Integer id1) &#123;</span><br><span class="line">        this.id1 = id1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAlarmMessage() &#123;</span><br><span class="line">        return alarmMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAlarmMessage(String alarmMessage) &#123;</span><br><span class="line">        this.alarmMessage = alarmMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public long getStartTime() &#123;</span><br><span class="line">        return startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setStartTime(long startTime) &#123;</span><br><span class="line">        this.startTime = startTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;AlarmMessage&#123;&quot; +</span><br><span class="line">                &quot;scopeId=&quot; + scopeId +</span><br><span class="line">                &quot;, name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, id0=&quot; + id0 +</span><br><span class="line">                &quot;, id1=&quot; + id1 +</span><br><span class="line">                &quot;, alarmMessage=&#x27;&quot; + alarmMessage + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, startTime=&quot; + startTime +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>定义告警Controller：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.web;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 该接口主要用于模拟超时，多次调用之后就可以生成告警信息</span><br><span class="line"> *</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 17:28</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class AlarmController &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 每次调用睡眠1.5秒，模拟超时的报警</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(value = &quot;/timeout&quot;)</span><br><span class="line">    public String timeout() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1500);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &quot;timeout&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>定义WebHooks：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.example.springboot2.web;</span><br><span class="line"></span><br><span class="line">import com.example.springboot2.domain.AlarmMessage;</span><br><span class="line">import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 产生告警的时候会调用接口</span><br><span class="line"> * </span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-20 17:31</span><br><span class="line"> */</span><br><span class="line">@RestController</span><br><span class="line">public class WebHooksController &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;AlarmMessage&gt; alarmMessageList = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 触发webhook</span><br><span class="line">     *</span><br><span class="line">     * @param alarmMessageList</span><br><span class="line">     */</span><br><span class="line">    @PostMapping(value = &quot;/webhook&quot;)</span><br><span class="line">    public void webhook(@RequestBody List&lt;AlarmMessage&gt; alarmMessageList) &#123;</span><br><span class="line"></span><br><span class="line">        this.alarmMessageList = alarmMessageList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 显示告警信息</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @GetMapping(value = &quot;/show&quot;)</span><br><span class="line">    public List&lt;AlarmMessage&gt; show() &#123;</span><br><span class="line">        return this.alarmMessageList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-3-部署测试"><a href="#3-5-3-部署测试" class="headerlink" title="3.5.3 部署测试"></a>3.5.3 部署测试</h3><ul>
<li><p>将项目打包并上传到/usr/local/skywalking中（略）。</p>
</li>
<li><p>修改告警规则配置文件，将webhook地址修改为：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 修改部分</span><br><span class="line">webhooks:</span><br><span class="line">  - http://127.0.0.1:8090/webhook</span><br><span class="line">#  - http://127.0.0.1/go-wechat/</span><br></pre></td></tr></table></figure>



<ul>
<li><p>重启Skywalking（略）。</p>
</li>
<li><p>启动SpringBoot应用：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar -Dserver.port=8090 -Dskywalking.agent.service_name=skywalking_mysql -jar springboot2-1.0.jar &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>不停的调用接口，接口地址为：<a target="_blank" rel="noopener" href="http://192.168.159.103:8090/timeout%E3%80%82">http://192.168.159.103:8090/timeout。</a></p>
</li>
<li><p>直到出现告警。</p>
</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193653641-fe329611-9ceb-4583-905e-23afda478d26.png" alt="img"></p>
<ul>
<li>查看告警信息：</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193665482-a40ae907-c97f-4d6f-9519-b87562b9feed.png" alt="img"></p>
<ul>
<li>从上图中可以看到，我们已经获取了告警相关的信息，在生产中使用可以在webhook接口中对接短信、邮件等平台，当告警出现的时候能迅速发送信息给对应的处理人员，提高故障处理的速度。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193653641-fe329611-9ceb-4583-905e-23afda478d26.png"></p>
<h1 id="4-Skywalking的原理"><a href="#4-Skywalking的原理" class="headerlink" title="4 Skywalking的原理"></a>4 Skywalking的原理</h1><h2 id="4-1-java-agent的原理"><a href="#4-1-java-agent的原理" class="headerlink" title="4.1 java agent的原理"></a>4.1 java agent的原理</h2><h3 id="4-1-1-概述"><a href="#4-1-1-概述" class="headerlink" title="4.1.1 概述"></a>4.1.1 概述</h3><p>我们知道，要使用Skywalking去监控服务，需要在其VM参数中添加“<code>-javaagent:/usr/local/skywalking/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar</code>”，这里就使用到了java agent技术。</p>
<h3 id="4-1-2-java-agent是什么？"><a href="#4-1-2-java-agent是什么？" class="headerlink" title="4.1.2 java agent是什么？"></a>4.1.2 java agent是什么？</h3><p>java agent是java命令的一个参数，参数<code>javaagent</code>可以用于指定一个jar包。这个jar包的MANIFEST.MF文件必须指定Premain-Class项。Premain-Class指定的那个类必须实现premain()方法。</p>
<p>当Java虚拟机启动时，在执行main函数之前，JVM会运行<code>-javaagent</code>所指定的jar包内Premain-Class这个类的premain方法。</p>
<h3 id="4-1-3-如何使用java-agent？"><a href="#4-1-3-如何使用java-agent？" class="headerlink" title="4.1.3 如何使用java agent？"></a>4.1.3 如何使用java agent？</h3><p>定义一个MANIFEST.MF文件，必须包含Premain-Class选项，通常也会加入Can-Redefine-Classes和Can-Retransform-Classes选项。</p>
<p>创建一个Premain-Class指定的类，类中包含premain方法，方法逻辑由用户自己确定。</p>
<p>将premain类和MANIFEST.MF文件打成jar包。</p>
<p>使用参数<code>-javaagent:jar包路径</code>启动要代理的方法。</p>
<h3 id="4-1-4-搭建java-agent工程"><a href="#4-1-4-搭建java-agent工程" class="headerlink" title="4.1.4 搭建java agent工程"></a>4.1.4 搭建java agent工程</h3><ul>
<li><p>使用Maven搭建java_agent总工程，其中java_agent_demo子工程是真正的逻辑实现，而java_agent_user子工程是测试。</p>
</li>
<li><p>在java_agent_demo的工程中引入maven-assembly-plugin插件，用于将java_agent_demo工程打成符合java agent标准的jar包：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;appendAssemblyId&gt;false&lt;/appendAssemblyId&gt;</span><br><span class="line">                &lt;descriptorRefs&gt;</span><br><span class="line">                    &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">                &lt;/descriptorRefs&gt;</span><br><span class="line">                &lt;archive&gt;</span><br><span class="line">                    &lt;!--自动添加META-INF/MANIFEST.MF --&gt;</span><br><span class="line">                    &lt;manifest&gt;</span><br><span class="line">                        &lt;addClasspath&gt;true&lt;/addClasspath&gt;</span><br><span class="line">                    &lt;/manifest&gt;</span><br><span class="line">                    &lt;manifestEntries&gt;</span><br><span class="line">                        &lt;Premain-Class&gt;PreMainAgent&lt;/Premain-Class&gt;</span><br><span class="line">                        &lt;Agent-Class&gt;PreMainAgent&lt;/Agent-Class&gt;</span><br><span class="line">                        &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt;</span><br><span class="line">                        &lt;Can-Retransform-Classes&gt;true&lt;/Can-Retransform-Classes&gt;</span><br><span class="line">                    &lt;/manifestEntries&gt;</span><br><span class="line">                &lt;/archive&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">                &lt;execution&gt;</span><br><span class="line">                    &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">                    &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                    &lt;goals&gt;</span><br><span class="line">                        &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">                    &lt;/goals&gt;</span><br><span class="line">                &lt;/execution&gt;</span><br><span class="line">            &lt;/executions&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li>在java_agent_demo工程创建PreMainAgent类。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line">public class PreMainAgent &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 在这个 premain 函数中，开发者可以进行对类的各种操作。</span><br><span class="line">     * 1、agentArgs 是 premain 函数得到的程序参数，随同 “– javaagent”一起传入。与 main 函数不同的是，</span><br><span class="line">     * 这个参数是一个字符串而不是一个字符串数组，如果程序参数有多个，程序将自行解析这个字符串。</span><br><span class="line">     * 2、Inst 是一个 java.lang.instrument.Instrumentation 的实例，由 JVM 自动传入。*</span><br><span class="line">     * java.lang.instrument.Instrumentation 是 instrument 包中定义的一个接口，也是这个包的核心部分，</span><br><span class="line">     * 集中了其中几乎所有的功能方法，例如类定义的转换和操作等等。</span><br><span class="line">     *</span><br><span class="line">     * @param agentArgs</span><br><span class="line">     * @param inst</span><br><span class="line">     */</span><br><span class="line">    public static void premain(String agentArgs, Instrumentation inst) &#123;</span><br><span class="line">        System.out.println(&quot;=========premain方法执行1========&quot;);</span><br><span class="line">        System.out.println(agentArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 如果不存在 premain(String agentArgs, Instrumentation inst)</span><br><span class="line">     * 则会执行 premain(String agentArgs)</span><br><span class="line">     *</span><br><span class="line">     * @param agentArgs</span><br><span class="line">     */</span><br><span class="line">    public static void premain(String agentArgs) &#123;</span><br><span class="line">        System.out.println(&quot;=========premain方法执行2========&quot;);</span><br><span class="line">        System.out.println(agentArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>通过IDEA，进行打包。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193683611-33d47471-e231-4caa-99a9-05ab64cf37bc.png" alt="img"></p>
<ul>
<li>java_agent_user工程新建一个测试类。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-21 08:46</span><br><span class="line"> */</span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;你好 世界&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>先运行一次，然后点击编辑MAIN启动类：</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193696116-e3d8c627-ba22-4021-beef-8148e7fde44f.png" alt="img"></p>
<ul>
<li>在VM Options中添加代码：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:D:/project/java_agent/java_agent_demo/target/java_agent_demo-1.0.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2021/png/513185/1611193735534-8bec0824-bfa8-4c07-9a93-e80a2b9d44be.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_31,text_6K645aSn5LuZ,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ul>
<li>启动的时候加载javaagent，指向java_agent_demo工程编译出来的javaagent的jar包地址。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193750015-cc691017-0a9b-4a68-8273-1261c476bdc6.png" alt="img"></p>
<h3 id="4-1-5-统计方法的调用时间"><a href="#4-1-5-统计方法的调用时间" class="headerlink" title="4.1.5 统计方法的调用时间"></a>4.1.5 统计方法的调用时间</h3><ul>
<li><p>Skywalking中对每个调用的时长都进行了统计，我们要使用ByteBuddy和java agent技术来统计方法的调用时长。</p>
</li>
<li><p>Byte Buddy是开源的、基于Apache2.0许可证的库，它致力于解决字节码操作和instrumentation API的复杂性。Byte Buddy所声称的目标是将显示的字节码操作隐藏在一个类型安全的领域特定语言背后，通过Byte Buddy，任何熟悉Java编程语言的人都有望非常容易的进行字节码的操作。Byte Buddy提供了额外的依赖API来生成java agent，可以轻松的增加我们已有的代码。</p>
</li>
<li><p>需要在java_agent_demo工程中添加如下的依赖：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;net.bytebuddy&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;byte-buddy&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.9.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;net.bytebuddy&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;byte-buddy-agent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.9.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li>新建一个MyInterceptor的类，用来统计调用的时长。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import net.bytebuddy.implementation.bind.annotation.Origin;</span><br><span class="line">import net.bytebuddy.implementation.bind.annotation.RuntimeType;</span><br><span class="line">import net.bytebuddy.implementation.bind.annotation.SuperCall;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.concurrent.Callable;</span><br><span class="line"></span><br><span class="line">public class MyInterceptor &#123;</span><br><span class="line">    @RuntimeType</span><br><span class="line">    public static Object intercept(@Origin Method method,</span><br><span class="line">                                   @SuperCall Callable&lt;?&gt; callable)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        long start = System.currentTimeMillis();</span><br><span class="line">        try &#123;</span><br><span class="line">            //执行原方法</span><br><span class="line">            return callable.call();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            //打印调用时长</span><br><span class="line">            System.out.println(method.getName() + &quot;:&quot; + (System.currentTimeMillis() - start)  + &quot;ms&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>修改PreMainAgent的代码：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import net.bytebuddy.agent.builder.AgentBuilder;</span><br><span class="line">import net.bytebuddy.description.method.MethodDescription;</span><br><span class="line">import net.bytebuddy.description.type.TypeDescription;</span><br><span class="line">import net.bytebuddy.dynamic.DynamicType;</span><br><span class="line">import net.bytebuddy.implementation.MethodDelegation;</span><br><span class="line">import net.bytebuddy.matcher.ElementMatchers;</span><br><span class="line">import net.bytebuddy.utility.JavaModule;</span><br><span class="line"></span><br><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line">public class PreMainAgent &#123;</span><br><span class="line"></span><br><span class="line">    public static void premain(String agentArgs, Instrumentation inst) &#123;</span><br><span class="line">        //创建一个转换器，转换器可以修改类的实现</span><br><span class="line">        //ByteBuddy对java agent提供了转换器的实现，直接使用即可</span><br><span class="line">        AgentBuilder.Transformer transformer = new AgentBuilder.Transformer() &#123;</span><br><span class="line">            public DynamicType.Builder&lt;?&gt; transform(DynamicType.Builder&lt;?&gt; builder, TypeDescription typeDescription, ClassLoader classLoader, JavaModule javaModule) &#123;</span><br><span class="line">                return builder</span><br><span class="line">                        // 拦截任意方法</span><br><span class="line">                        .method(ElementMatchers.&lt;MethodDescription&gt;any())</span><br><span class="line">                        // 拦截到的方法委托给TimeInterceptor</span><br><span class="line">                        .intercept(MethodDelegation.to(MyInterceptor.class));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        new AgentBuilder // Byte Buddy专门有个AgentBuilder来处理Java Agent的场景</span><br><span class="line">                .Default()</span><br><span class="line">                // 根据包名前缀拦截类</span><br><span class="line">                .type(ElementMatchers.nameStartsWith(&quot;com.agent&quot;))</span><br><span class="line">                // 拦截到的类由transformer处理</span><br><span class="line">                .transform(transformer)</span><br><span class="line">                .installOn(inst);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>对java_agent_demo工程重新打包。</p>
</li>
<li><p>将java_agent_user工程中的Main类方法com.agent包下，修改代码的内容为：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.agent;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author 许大仙</span><br><span class="line"> * @version 1.0</span><br><span class="line"> * @since 2021-01-21 08:46</span><br><span class="line"> */</span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;你好 世界&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>执行Main方法之后的显示结果为：</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193765061-5f4578a5-469e-49e3-b3ac-798c406efb11.png" alt="img"></p>
<ul>
<li>我们在没有修改代码的情况下，利用了java agent和Byte Buddy统计出了方法的时长，Skywalking的agent也是基于这些技术来实现统计时长的调用的。</li>
</ul>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193750015-cc691017-0a9b-4a68-8273-1261c476bdc6.png"></p>
<h2 id="4-2-Open-Tracing介绍"><a href="#4-2-Open-Tracing介绍" class="headerlink" title="4.2 Open Tracing介绍"></a>4.2 Open Tracing介绍</h2><h3 id="4-2-1-概述"><a href="#4-2-1-概述" class="headerlink" title="4.2.1 概述"></a>4.2.1 概述</h3><p>Open Tracing通过提供平台无关、厂商无关的API，使得开发人员能够方便的添加（或更换）追踪系统的实现。Open Tracing最核心的概念就是Trace。</p>
<h3 id="4-2-2-Trace"><a href="#4-2-2-Trace" class="headerlink" title="4.2.2 Trace"></a>4.2.2 Trace</h3><p>在广义上，一个trace代表了一个事务或者流程（在分布式）系统中的执行过程。在Open Tracing标准中，trace是多个span的一个有向无环图（DAG），每一个span代表trace中被命名并计时的连续性的执行片段。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193776088-693cbdc4-a0bb-4aa7-b2cd-6be381c8dcc1.png" alt="img"></p>
<p>例如客户端发起一次请求，就可以认为是一次Trace。将上面的图通过Open Tracing的语义修改完之后做可视化，得到下面的图：</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193788620-83dd9fc6-bd6d-4908-83a9-492664f97c99.png" alt="img"></p>
<p>图中的每一个色块其实就是一个span。</p>
<h3 id="4-2-3-Span的概念"><a href="#4-2-3-Span的概念" class="headerlink" title="4.2.3 Span的概念"></a>4.2.3 Span的概念</h3><p>一个Span代表系统中具有开始时间和执行时长的逻辑运行单元。span之间通过嵌套或者顺序排列建立逻辑因果关系。</p>
<p>Span里面的信息包含：操作的名字，开始时间和结束时间，可以携带多个<code>key:value</code>构成的Tags（key必须是String，value可以是String、Boolean或者数字等），还可以携带Logs信息（不一定所有的实现都支持），也必须是<code>key:value</code>形式。</p>
<p>下面的例子是一个Trace，里面有8个Span：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">       [Span A]  ←←←(the root span)        </span><br><span class="line">           |</span><br><span class="line">    +------+------+   </span><br><span class="line">    |             |</span><br><span class="line">[Span B]      [Span C] ←←←(Span C 是    Span A 的孩子节点, ChildOf)   </span><br><span class="line">    |            |</span><br><span class="line">[Span D]     +---+-------+</span><br><span class="line">             |           |</span><br><span class="line">          [Span E]    [Span F] &gt;&gt;&gt; [Span G] &gt;&gt;&gt; [Span H]                    </span><br><span class="line">                                        ↑</span><br><span class="line">                                        ↑</span><br><span class="line">                                        ↑</span><br><span class="line">                        (Span G 在 Span F 后被调用, FollowsFrom)</span><br></pre></td></tr></table></figure>



<p>一个Span可以和一个或者多个Span间存在因果关系。Open Tracing定义了两种关系：ChildOf和FollowsFrom。这两种引用类型代表了子节点和父节点间的直接因果关系。未来，OpenTracing将支 持非因果关系的span引用关系。（例如：多个span被批量处理，span在同一个队列中，等等）</p>
<p>ChildOf 很好理解，就是父亲 Span 依赖另一个孩子 Span。比如函数调用，被调者是调用者的孩子，比如说 RPC 调用，服务端那边的Span，就是 ChildOf 客户端的。很多并发的调用，然后将结果聚合起来的操作，就构成了 ChildOf 关系。</p>
<p>如果父亲 Span 并不依赖于孩子 Span 的返回结果，这时可以说它他构成 FollowsFrom 关系。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193803412-48964956-1e9e-4fb8-a3b9-fde3a3f90158.png" alt="img"></p>
<h3 id="4-2-4-Log的概念"><a href="#4-2-4-Log的概念" class="headerlink" title="4.2.4 Log的概念"></a>4.2.4 Log的概念</h3><p>每个Span可以进行多次Logs操作，每一个Logs操作，都需要一个带时间戳的时间名称、以及可选的任意大小的存储结果。</p>
<p>如下图是一个异常的Log：</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193814571-5fe3a6ce-93c5-4cfb-9a14-974adb3ed0b1.png" alt="img"></p>
<h3 id="4-2-5-Tags的概念"><a href="#4-2-5-Tags的概念" class="headerlink" title="4.2.5 Tags的概念"></a>4.2.5 Tags的概念</h3><p>每个Span可以有多个键值对（<code>key:value</code>）形式的Tags，Tags是没有时间戳的，支持简单的对Span进行注解和补充。</p>
<p><img src="https://note-flystar.oss-cn-shanghai.aliyuncs.com/img/1611193827682-63aec643-b5a6-4f73-a2d3-1e6c1389724e.png" alt="Tags的概念.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/sunxiaping/yg511q/nwbfui">https://www.yuque.com/sunxiaping/yg511q/nwbfui</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">pangyannan</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://pangyannan.github.io/2021/10/25/skywalking/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AAskywalking/">https://pangyannan.github.io/2021/10/25/skywalking/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AAskywalking/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">pangyannan</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/10/25/spring/ApplicationContext/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-10-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            pangyannan
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/10/25/skywalking/docker%E5%AE%89%E8%A3%85skywalking/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-10-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            pangyannan
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">pangyannan</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
